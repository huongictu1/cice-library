-- Ví dụ về lệnh tạo chỉ mục cho cột Barcode và DateCurent trong bảng ChemicalStore
CREATE INDEX idx_barcode_datecurent ON dbo.ChemicalStore(Barcode, DateCurent);

-- Ví dụ về lệnh tạo chỉ mục cho cột Barcode và Date trong bảng Inventory
CREATE INDEX idx_barcode_date ON dbo.Inventory(Barcode, Date);


CREATE PROC [dbo].[Report2ALL]
(
    @Month as int,
    @Year as int,
    @Dept as int,
    @Stock as int
)
AS
BEGIN
    SELECT DISTINCT ROW_NUMBER() OVER (ORDER BY t.Barcode) as No, t.*
    FROM
    (
        SELECT
            c.ChemicalName,
            c.ProduceCode,
            d.Name as Dept,
            c.Barcode,
            c.ControlNo,
            nu.Name as Unit,
            dbo.LastMonthStock(c.Barcode, @Month, @Year) as LastMonthStock,
            dbo.SumInput(c.Barcode, @Month, @Year) as TotalInput,
            dbo.SumOutput(c.Barcode, @Month, @Year) as TotalOutput,
            dbo.GetActual(c.Barcode, @Month, @Year) as ActualInventory,
            dbo.MinIsZero((dbo.LastMonthStock(c.Barcode, @Month, @Year) + dbo.SumInput(c.Barcode, @Month, @Year)) - dbo.SumOutput(c.Barcode, @Month, @Year)) as CalculationStock,
            ROUND(dbo.GetActual(c.Barcode, @Month, @Year) - (dbo.LastMonthStock(c.Barcode, @Month, @Year) + dbo.SumInput(c.Barcode, @Month, @Year) - dbo.SumOutput(c.Barcode, @Month, @Year)), 3) as Difference,
            dbo.Get_Reason(c.Barcode, @Month, @Year) as Reason,
            dbo.GetSmaxALL2(c.Barcode, @Month, @Year) as STT,
            dbo.GetStatus(c.Barcode, @Month, @Year) as Status,
            CONVERT(varchar, dbo.GetDateApproval(c.Barcode, @Month, @Year), 121) as DateApproval,
            dbo.GetPICConfirm(c.Barcode, @Month, @Year) as Pic,
            d.ID,
            cs.StockID
        FROM dbo.ChemicalStore c
        LEFT JOIN ChemicalList cs ON c.Barcode = cs.Barcode
        LEFT JOIN Dept d ON c.Dept = d.ID
        LEFT JOIN Unit u ON c.Unit = u.ID
        WHERE MONTH(DateCurrent) = @Month AND YEAR(DateCurrent) = @Year
        AND d.ID = (CASE WHEN @Dept = -1 THEN d.ID ELSE @Dept END)
        AND cs.StockID = (CASE WHEN @Stock = -1 THEN cs.StockID ELSE @Stock END)
    ) as t
END

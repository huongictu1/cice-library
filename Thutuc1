CREATE PROC [dbo].[Report2ALL](
    @Month AS INT,
    @Year AS INT,
    @Dept AS INT,
    @Stock AS INT
)
AS
BEGIN
    WITH CalculatedValues AS (
        -- Calculate values once
        SELECT
            c.Barcode,
            dbo.LastMonthStock(c.Barcode, @Month, @Year) AS LastMonthStockValue,
            dbo.SumInput(c.Barcode, @Month, @Year) AS SumInputValue,
            dbo.SumOutput(c.Barcode, @Month, @Year) AS SumOutputValue,
            dbo.GetActual(c.Barcode, @Month, @Year) AS ActualInventory,
            dbo.Get_Reason(c.Barcode, @Month, @Year) AS Reason,
            dbo.GetSmaxALL2(c.Barcode, @Month, @Year) AS STT,
            dbo.GetStatus(c.Barcode, @Month, @Year) AS [Status],
            dbo.GetDateApproval(c.Barcode, @Month, @Year) AS DateApproval,
            dbo.GetPICConfirm(c.Barcode, @Month, @Year) AS Pic
        FROM [dbo].[ChemicalStore] c
            LEFT JOIN ChemicalList cs ON c.Barcode = cs.Barcode
            LEFT JOIN Dept d ON c.Dept = d.ID 
            LEFT JOIN Unit u ON c.Unit = u.ID
        WHERE 
            (MONTH(DateCurrent) = @Month AND YEAR(DateCurrent) = @Year)
            AND (
                d.ID = (CASE WHEN @Dept = -1 THEN d.ID ELSE @Dept END)
                AND cs.StockID = (CASE WHEN @Stock = -1 THEN cs.StockID ELSE @Stock END)
            )
    )

    SELECT ROW_NUMBER() OVER (ORDER BY t.Barcode) AS No, t.*
    FROM (
        SELECT
            c.ChemicalName,
            c.ProduceCode,
            d.Name AS Dept,
            c.Barcode,
            c.ControlNo,
            u.Name AS Unit,
            cv.LastMonthStockValue AS LastMonthStock,
            cv.SumInputValue AS TotalInput,
            cv.SumOutputValue AS TotalOutput,
            cv.ActualInventory,
            dbo.MinIsZero((cv.LastMonthStockValue + cv.SumInputValue) - cv.SumOutputValue) AS CalculationStock,
            ROUND(cv.ActualInventory - (cv.LastMonthStockValue + cv.SumInputValue - cv.SumOutputValue), 3) AS Differed,
            cv.Reason,
            cv.STT,
            cv.[Status],
            CONVERT(VARCHAR, cv.DateApproval, 121) AS DateApproval,
            cv.Pic,
            d.ID,
            cs.StockID
        FROM CalculatedValues cv
            JOIN [dbo].[ChemicalStore] c ON cv.Barcode = c.Barcode
            LEFT JOIN ChemicalList cs ON c.Barcode = cs.Barcode
            LEFT JOIN Dept d ON c.Dept = d.ID 
            LEFT JOIN Unit u ON c.Unit = u.ID
    ) AS t;

END

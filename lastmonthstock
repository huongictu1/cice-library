CREATE FUNCTION [dbo].[LastMonthStock]
(
    @Barcode NVARCHAR(50),
    @Month FLOAT,
    @Year FLOAT
)
RETURNS FLOAT
AS
BEGIN
    DECLARE @LastMonthStock FLOAT;

    -- If the current month is January, set the month to 12 and decrement the year
    IF (@Month = 1) 
    BEGIN
        SET @Year = @Year - 1;
        SET @Month = 12;
    END

    -- Calculate the last day of the previous month
    DECLARE @LastDayOfPrevMonth DATE = DATEADD(DAY, -DAY(DATEADD(MONTH, 1, CAST(@Year AS NVARCHAR(50)) + '-' + CAST(@Month AS NVARCHAR(50)) + '-01')), CAST(@Year AS NVARCHAR(50)) + '-' + CAST(@Month AS NVARCHAR(50)) + '-01');

    -- Calculate the last month stock using a single query
    SELECT @LastMonthStock = ISNULL(MAX(ActualInventory), 0)
    FROM dbo.Inventory
    WHERE
        Barcode = @Barcode
        AND Date <= @LastDayOfPrevMonth;

    RETURN @LastMonthStock;
END
